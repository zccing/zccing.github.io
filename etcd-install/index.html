<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<meta http-equiv=x-ua-compatible content="IE=edge, chrome=1">
<title>etcd安装配置笔记 - 晨曦</title><meta name=Description content="通过二进制方式安装最新版的etcd，并做高可用集群配置"><meta property="og:title" content="etcd安装配置笔记">
<meta property="og:description" content="通过二进制方式安装最新版的etcd，并做高可用集群配置">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.net-cc.com/etcd-install/"><meta property="og:image" content="https://www.net-cc.com/images/logo.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-09-06T19:42:47+08:00">
<meta property="article:modified_time" content="2021-12-06T15:32:36+00:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://www.net-cc.com/images/logo.png">
<meta name=twitter:title content="etcd安装配置笔记">
<meta name=twitter:description content="通过二进制方式安装最新版的etcd，并做高可用集群配置">
<meta name=application-name content="晨曦">
<meta name=apple-mobile-web-app-title content="晨曦"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://www.net-cc.com/etcd-install/><link rel=prev href=https://www.net-cc.com/openssl/><link rel=next href=https://www.net-cc.com/k8s-install/><link rel=alternate href=/etcd-install/index.xml type=application/rss+xml title=晨曦>
<link rel=feed href=/etcd-install/index.xml type=application/rss+xml title=晨曦><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"etcd安装配置笔记","inLanguage":"zh-cn","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.net-cc.com\/etcd-install\/"},"image":["https:\/\/www.net-cc.com\/images"],"genre":"posts","keywords":"k8s, etcd","wordcount":997,"url":"https:\/\/www.net-cc.com\/etcd-install\/","datePublished":"2020-09-06T19:42:47+08:00","dateModified":"2021-12-06T15:32:36+00:00","publisher":{"@type":"Organization","name":"cc","logo":"https:\/\/www.net-cc.com"},"author":{"@type":"Person","name":"Net Cc"},"description":"通过二进制方式安装最新版的etcd，并做高可用集群配置"}</script></head>
<body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title=晨曦><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/logo.png data-srcset="/images/logo.png, /images/logo.png 1.5x, /images/logo.png 2x" data-sizes=auto alt=/images/logo.png title=/images/logo.png>晨曦</a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts/> 所有文章 </a><a class=menu-item href=/tags/> 标签 </a><a class=menu-item href=/categories/> 分类 </a><a class=menu-item href=/about/ title=关于> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容 id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-desktop>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title=晨曦><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/logo.png data-srcset="/images/logo.png, /images/logo.png 1.5x, /images/logo.png 2x" data-sizes=auto alt=/images/logo.png title=/images/logo.png>晨曦</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><div class=search-wrapper>
<div class="search mobile" id=search-mobile>
<input type=text placeholder=搜索文章标题或内容 id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-mobile>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</div>
<a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>
取消
</a>
</div><a class=menu-item href=/posts/ title>所有文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title=关于>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>目录</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animated flipInX">etcd安装配置笔记</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=https://www.net-cc.com title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>Net Cc</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/k8s/><i class="far fa-folder fa-fw"></i>K8S</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-09-06>2020-09-06</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 997 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 5 分钟&nbsp;</div>
</div><div class="details toc" id=toc-static kept>
<div class="details-summary toc-title">
<span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#节点初始化>节点初始化</a></li>
</ul>
<ul>
<li><a href=#etcd-ca>etcd-ca</a></li>
<li><a href=#etcd-server-证书>etcd-server 证书</a></li>
<li><a href=#etcd-client-证书>etcd-client 证书</a></li>
<li><a href=#复制证书到各节点>复制证书到各节点</a></li>
</ul>
<ul>
<li><a href=#下载etcd二进制文件>下载etcd二进制文件</a></li>
<li><a href=#添加system服务>添加system服务</a></li>
</ul>
<ul>
<li><a href=#添加配置文件>添加配置文件</a></li>
<li><a href=#启动etcd服务>启动ETCD服务</a></li>
<li><a href=#测试etcd>测试etcd</a></li>
</ul>
<ul>
<li><a href=#添加集群成员>添加集群成员</a></li>
<li><a href=#修改配置文件>修改配置文件</a></li>
<li><a href=#启动新节点>启动新节点</a></li>
<li><a href=#测试etcd-1>测试etcd</a></li>
</ul>
</nav></div>
</div><div class=content id=content><p>通过二进制方式安装最新版的etcd，并做高可用集群配置</p>
<h1 id=节点信息>节点信息</h1>
<table>
<thead>
<tr>
<th>IP地址</th>
<th>主机名称</th>
<th>DNS记录</th>
<th>类型</th>
<th>系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.122.10</td>
<td>node1</td>
<td>node1</td>
<td>etcd</td>
<td>centos7</td>
</tr>
<tr>
<td>192.168.122.11</td>
<td>node2</td>
<td>node2</td>
<td>etcd</td>
<td>centos7</td>
</tr>
<tr>
<td>192.168.122.12</td>
<td>node3</td>
<td>node3</td>
<td>etcd</td>
<td>centos8</td>
</tr>
</tbody>
</table>
<h2 id=节点初始化>节点初始化</h2>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=c1># 创建用户和目录</span>
groupadd -r etcd
<span class=c1># -k MAIL_DIR=/dev/null参数不创建此用户的mail目录</span>
useradd  -s /sbin/nologin -d /var/lib/etcd -g etcd -c <span class=s2>&#34;etcd user&#34;</span> -r -K <span class=nv>MAIL_DIR</span><span class=o>=</span>/dev/null etcd
mkdir -p /opt/etcd/<span class=o>{</span>ssl,etc,log,bin,data<span class=o>}</span>
<span class=c1># 开通防火墙端口</span>
firewall-cmd --add-service<span class=o>=</span>etcd-server --permanent
firewall-cmd --add-service<span class=o>=</span>etcd-client --permanent
firewall-cmd --reload
</code></pre></td></tr></table>
</div>
</div><h1 id=pki证书管理>PKI证书管理</h1>
<p><strong>注意：证书我是在node3上进行生成管理的</strong></p>
<p>使用openssl生成证书，可以参考: <a href=/openssl/ title=openssl证书管理 rel>openssl证书管理</a></p>
<p>需要这些证书</p>
<table>
<thead>
<tr>
<th>默认 CN</th>
<th>父级 CA</th>
<th>O (位于 Subject 中)</th>
<th>类型</th>
<th>主机 (SAN)</th>
</tr>
</thead>
<tbody>
<tr>
<td>etcd-server</td>
<td>etcd-ca</td>
<td></td>
<td>server, client</td>
<td>&lt;主机名称>, &lt;IP地址>, localhost, 127.0.0.1</td>
</tr>
<tr>
<td>etcd-client</td>
<td>etcd-ca</td>
<td>system:masters</td>
<td>client</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id=etcd-ca>etcd-ca</h2>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>mkdir -p ~/ca/etcd-ca/<span class=o>{</span>etcd-server,etcd-client<span class=o>}</span>
<span class=nb>cd</span> ~/ca/etcd-ca
openssl genrsa -aes256 -out etcd-ca.key <span class=m>4096</span> <span class=c1># 对key使用了aes256进行加密，所以需要输入密码</span>

<span class=c1># etcd-ca的证书</span>
openssl req -extensions v3_ca <span class=se>\
</span><span class=se></span>-subj <span class=s2>&#34;/C=CN/ST=ShangHai/L=ShangHai/O=net-cc.com/OU=net-cc.com/CN=etcd-ca/emailAddress=admin@admin.com&#34;</span> <span class=se>\
</span><span class=se></span>-new -x509 -days <span class=m>14500</span> -sha256 <span class=se>\
</span><span class=se></span>-key etcd-ca.key -out etcd-ca.crt

<span class=c1># 创建证书签名用到的配置文件</span>
cat &gt; etcd-ca.conf<span class=s>&lt;&lt;EOF
</span><span class=s># 用来对服务端证书签名
</span><span class=s>[ req_server ]
</span><span class=s>subjectKeyIdentifier = hash
</span><span class=s>basicConstraints = CA:FALSE
</span><span class=s>authorityKeyIdentifier = keyid,issuer:always
</span><span class=s>keyUsage = critical, digitalSignature, keyEncipherment
</span><span class=s>extendedKeyUsage = clientAuth, serverAuth
</span><span class=s>subjectAltName = @alt_names
</span><span class=s># etcd客户端的IP地址和dns记录（SAN）
</span><span class=s>[ alt_names ]
</span><span class=s>DNS.1 = node1
</span><span class=s>DNS.2 = node2
</span><span class=s>DNS.3 = node3
</span><span class=s>DNS.4 = localhost
</span><span class=s>IP.1 = 192.168.122.10
</span><span class=s>IP.2 = 192.168.122.12
</span><span class=s>IP.3 = 192.168.122.13
</span><span class=s>IP.4 = 127.0.0.1
</span><span class=s># 用来对客户端证书签名
</span><span class=s>[ req_client ]
</span><span class=s>subjectKeyIdentifier = hash
</span><span class=s>basicConstraints = CA:FALSE
</span><span class=s>authorityKeyIdentifier = keyid,issuer:always
</span><span class=s>keyUsage = critical, digitalSignature, keyEncipherment
</span><span class=s>extendedKeyUsage = clientAuth
</span><span class=s>EOF</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=etcd-server-证书>etcd-server 证书</h2>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=nb>cd</span> ~/ca/etcd-ca/etcd-server

<span class=c1># 创建密钥，不要加密，不然程序无法解析</span>
openssl genrsa -out etcd-server.key <span class=m>2048</span>

<span class=c1># 创建证书请求文件</span>
openssl req -new -sha256 <span class=se>\
</span><span class=se></span>-subj <span class=s2>&#34;/C=CN/ST=ShangHai/L=ShangHai/O=net-cc.com/OU=net-cc.com/CN=etcd-server/emailAddress=admin@admin.com&#34;</span> <span class=se>\
</span><span class=se></span>-key etcd-server.key -out etcd-server.csr

<span class=c1># 使用etcd-ca进行签名获取带有SAN扩展的证书</span>
openssl x509 -in etcd-server.csr -out etcd-server.crt <span class=se>\
</span><span class=se></span>-CA ../etcd-ca.crt -CAkey ../etcd-ca.key -CAcreateserial <span class=se>\
</span><span class=se></span>-extfile ../etcd-ca.conf -extensions req_server <span class=se>\
</span><span class=se></span>-req -sha256 -days <span class=m>7300</span>

<span class=c1># 更改证书权限</span>
rm -rf etcd-server.csr
chmod <span class=m>444</span> etcd-server.crt
chmod <span class=m>400</span> etcd-server.key
</code></pre></td></tr></table>
</div>
</div><h2 id=etcd-client-证书>etcd-client 证书</h2>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=nb>cd</span> ~/ca/etcd-ca/etcd-client
<span class=c1># 创建密钥</span>
openssl genrsa -out etcd-client.key <span class=m>2048</span>

<span class=c1># 创建证书请求文件</span>
openssl req -new -sha256 <span class=se>\
</span><span class=se></span>-subj <span class=s2>&#34;/C=CN/ST=ShangHai/L=ShangHai/O=system:masters/OU=net-cc.com/CN=etcd-client/emailAddress=admin@admin.com&#34;</span> <span class=se>\
</span><span class=se></span>-key etcd-client.key -out etcd-client.csr

<span class=c1># 使用etcd-ca进行签名</span>
openssl x509 -in etcd-client.csr -out etcd-client.crt <span class=se>\
</span><span class=se></span>-CA ../etcd-ca.crt -CAkey ../etcd-ca.key -CAcreateserial <span class=se>\
</span><span class=se></span>-extfile ../etcd-ca.conf -extensions req_client <span class=se>\
</span><span class=se></span>-req -sha256 -days <span class=m>7300</span> 

rm -f etcd-client.csr
chmod <span class=m>444</span> etcd-client.crt
chmod <span class=m>400</span> etcd-client.key
</code></pre></td></tr></table>
</div>
</div><h2 id=复制证书到各节点>复制证书到各节点</h2>
<ul>
<li>
<p>etcd-server节点：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=nb>cd</span> ~/ca/etcd-ca/etcd-server
cp ../etcd-ca.crt etcd-server.crt etcd-server.key /opt/etcd/ssl/
scp ../etcd-ca.crt etcd-server.crt etcd-server.key root@node1:/opt/etcd/ssl/
scp ../etcd-ca.crt etcd-server.crt etcd-server.key root@node2:/opt/etcd/ssl/
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>etcd-client节点</p>
<p>证书密钥文件到需要使用etcd的程序的证书密钥目录内（如K8S），以便访问etcd服务的时候调用即可: <code>etcd-ca.crt，etcd-client.crt，etcd-client.key</code></p>
<p>可以先复制到~/.pki目录，方便etcdctl客户端程序调用</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=nb>cd</span> ~/ca/etcd-ca/etcd-client
mkdir -p ~/.pki
cp ../etcd-ca.crt etcd-client.crt etcd-client.key ~/.pki/
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h1 id=安装etcd>安装etcd</h1>
<p>三个节点上都要先安装etcd，然后在根据节点主机名称、ip地址来修改配置文件</p>
<h2 id=下载etcd二进制文件>下载etcd二进制文件</h2>
<p>在node3上下载二进制文件，然后传到其他节点上</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=c1># etcd的版本</span>
<span class=nv>ETCD_VER</span><span class=o>=</span>v3.4.13
<span class=c1># 通过github下载</span>
<span class=nv>GITHUB_URL</span><span class=o>=</span>https://github.com/etcd-io/etcd/releases/download
<span class=nv>DOWNLOAD_URL</span><span class=o>=</span><span class=si>${</span><span class=nv>GITHUB_URL</span><span class=si>}</span>
rm -f /tmp/etcd-<span class=si>${</span><span class=nv>ETCD_VER</span><span class=si>}</span>-linux-amd64.tar.gz
rm -rf /tmp/etcd-download-test <span class=o>&amp;&amp;</span> mkdir -p /tmp/etcd-download-test
curl -L <span class=si>${</span><span class=nv>DOWNLOAD_URL</span><span class=si>}</span>/<span class=si>${</span><span class=nv>ETCD_VER</span><span class=si>}</span>/etcd-<span class=si>${</span><span class=nv>ETCD_VER</span><span class=si>}</span>-linux-amd64.tar.gz -o /tmp/etcd-<span class=si>${</span><span class=nv>ETCD_VER</span><span class=si>}</span>-linux-amd64.tar.gz
tar xzvf /tmp/etcd-<span class=si>${</span><span class=nv>ETCD_VER</span><span class=si>}</span>-linux-amd64.tar.gz -C /tmp/etcd-download-test --strip-components<span class=o>=</span><span class=m>1</span>
<span class=c1># 复制到程序目录</span>
cp /tmp/etcd-download-test/etcd* /opt/etcd/bin/
<span class=c1># 传到其他节点</span>
scp /tmp/etcd-download-test/etcd* root@node1:/opt/etcd/bin/
scp /tmp/etcd-download-test/etcd* root@node2:/opt/etcd/bin/
<span class=c1># 清理</span>
rm -rf /tmp/etcd-download-test/
rm -f /tmp/etcd-<span class=si>${</span><span class=nv>ETCD_VER</span><span class=si>}</span>-linux-amd64.tar.gz
</code></pre></td></tr></table>
</div>
</div><h2 id=添加system服务>添加system服务</h2>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>cat &gt; /usr/lib/systemd/system/etcd.service<span class=s>&lt;&lt;EOF
</span><span class=s>[Unit]
</span><span class=s>Description=Etcd Server
</span><span class=s>After=network.target
</span><span class=s>After=network-online.target
</span><span class=s>Wants=network-online.target
</span><span class=s>
</span><span class=s>[Service]
</span><span class=s>WorkingDirectory=/opt/etcd/data
</span><span class=s>EnvironmentFile=/opt/etcd/etc/config
</span><span class=s>User=etcd
</span><span class=s># set GOMAXPROCS to number of processors
</span><span class=s>ExecStart=/opt/etcd/bin/etcd 
</span><span class=s>Restart=on-failure
</span><span class=s>RestartSec=5
</span><span class=s>LimitNOFILE=65536
</span><span class=s>
</span><span class=s>[Install]
</span><span class=s>WantedBy=multi-user.target
</span><span class=s>EOF</span>

<span class=c1># 配置etcd的配置文件位置</span>
<span class=nb>echo</span> <span class=s1>&#39;ETCD_CONFIG_FILE=&#34;/opt/etcd/etc/etcd.conf&#34;&#39;</span> &gt; /opt/etcd/etc/config

<span class=c1># 复制到node1</span>
scp /usr/lib/systemd/system/etcd.service root@node1:/usr/lib/systemd/system/etcd.service
scp /opt/etcd/etc/config root@node1:/opt/etcd/etc/config
<span class=c1># 复制到node2</span>
scp /usr/lib/systemd/system/etcd.service root@node2:/usr/lib/systemd/system/etcd.service
scp /opt/etcd/etc/config root@node2:/opt/etcd/etc/config
</code></pre></td></tr></table>
</div>
</div><h1 id=初始集群>初始集群</h1>
<p>我是先使用node1和node3创建初始集群，然后在动态添加node2节点</p>
<h2 id=添加配置文件>添加配置文件</h2>
<p>以下配置文件中选项的官方描述：<a href=https://etcd.io/docs/v3.4.0/op-guide/configuration/ target=_blank rel="noopener noreffer">https://etcd.io/docs/v3.4.0/op-guide/configuration/</a></p>
<ul>
<li>
<p>node1配置文件</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>cat &gt; /opt/etcd/etc/etcd.conf<span class=s>&lt;&lt;EOF
</span><span class=s>name: &#39;node1&#39;
</span><span class=s>data-dir: &#39;&#39;
</span><span class=s>wal-dir: &#39;&#39;
</span><span class=s>listen-peer-urls: https://192.168.122.10:2380
</span><span class=s>listen-client-urls: https://192.168.122.10:2379,https://127.0.0.1:2379
</span><span class=s>initial-advertise-peer-urls: https://node1:2380
</span><span class=s>advertise-client-urls: https://node1:2379
</span><span class=s>initial-cluster: node1=https://node1:2380,node3=https://node3:2380
</span><span class=s>initial-cluster-token: &#39;k8s&#39;
</span><span class=s>initial-cluster-state: &#39;new&#39;
</span><span class=s>enable-v2: true
</span><span class=s>enable-pprof: true
</span><span class=s>debug: false
</span><span class=s>logger: zap
</span><span class=s># 客户端到服务器端通讯
</span><span class=s>client-transport-security:
</span><span class=s>    cert-file: /opt/etcd/ssl/etcd-server.crt
</span><span class=s>    key-file: /opt/etcd/ssl/etcd-server.key
</span><span class=s>    client-cert-auth: true
</span><span class=s>    trusted-ca-file: /opt/etcd/ssl/etcd-ca.crt
</span><span class=s>    auto-tls: false
</span><span class=s># 对等通讯 (服务器到服务器/集群)
</span><span class=s>peer-transport-security:
</span><span class=s>    cert-file: /opt/etcd/ssl/etcd-server.crt
</span><span class=s>    key-file: /opt/etcd/ssl/etcd-server.key
</span><span class=s>    client-cert-auth: true
</span><span class=s>    trusted-ca-file: /opt/etcd/ssl/etcd-ca.crt
</span><span class=s>    auto-tls: false
</span><span class=s>EOF</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>node3配置文件</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>cat &gt; /opt/etcd/etc/etcd.conf<span class=s>&lt;&lt;EOF
</span><span class=s>name: &#39;node3&#39;
</span><span class=s>data-dir: &#39;&#39;
</span><span class=s>wal-dir: &#39;&#39;
</span><span class=s>listen-peer-urls: https://192.168.122.12:2380
</span><span class=s>listen-client-urls: https://192.168.122.12:2379,https://127.0.0.1:2379
</span><span class=s>initial-advertise-peer-urls: https://node3:2380
</span><span class=s>advertise-client-urls: https://node3:2379
</span><span class=s>initial-cluster: node1=https://node1:2380,node3=https://node3:2380
</span><span class=s>initial-cluster-token: &#39;k8s&#39;
</span><span class=s>initial-cluster-state: &#39;new&#39;
</span><span class=s>enable-v2: true
</span><span class=s>enable-pprof: true
</span><span class=s>debug: false
</span><span class=s>logger: zap
</span><span class=s># 客户端到服务器端通讯
</span><span class=s>client-transport-security:
</span><span class=s>    cert-file: /opt/etcd/ssl/etcd-server.crt
</span><span class=s>    key-file: /opt/etcd/ssl/etcd-server.key
</span><span class=s>    client-cert-auth: true
</span><span class=s>    trusted-ca-file: /opt/etcd/ssl/etcd-ca.crt
</span><span class=s>    auto-tls: false
</span><span class=s># 对等通讯 (服务器到服务器/集群)
</span><span class=s>peer-transport-security:
</span><span class=s>    cert-file: /opt/etcd/ssl/etcd-server.crt
</span><span class=s>    key-file: /opt/etcd/ssl/etcd-server.key
</span><span class=s>    client-cert-auth: true
</span><span class=s>    trusted-ca-file: /opt/etcd/ssl/etcd-ca.crt
</span><span class=s>    auto-tls: false
</span><span class=s>EOF</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id=启动etcd服务>启动ETCD服务</h2>
<p>先启动node1，然后在启动node3，每个节点的目录权限别忘记更改</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=c1># 设置权限</span>
chown etcd:etcd -R /opt/etcd/<span class=o>{</span>data,etc,log,ssl<span class=o>}</span>
chmod <span class=m>700</span> /opt/etcd/data
restorecon -R /opt/etcd

<span class=c1># 启动服务</span>
systemctl daemon-reload
systemctl start etcd.service
systemctl <span class=nb>enable</span> etcd.service
</code></pre></td></tr></table>
</div>
</div><h2 id=测试etcd>测试etcd</h2>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>
<span class=c1># 由于参数太多，所以添加etcdctl参数环境变量</span>
cat &gt;&gt; ~/.bashrc<span class=s>&lt;&lt;EOF
</span><span class=s>export ETCDCTL_API=3
</span><span class=s>export ETCDCTL_CACERT=$HOME/.pki/etcd-ca.crt
</span><span class=s>export ETCDCTL_CERT=$HOME/.pki/etcd-client.crt
</span><span class=s>export ETCDCTL_KEY=$HOME/.pki/etcd-client.key
</span><span class=s>export ETCDCTL_ENDPOINTS=https://node1:2379,https://node3:2379,https://node2:2379
</span><span class=s>
</span><span class=s>PATH=$PATH:$HOME/bin:/opt/etcd/bin
</span><span class=s>export PATH
</span><span class=s>EOF</span>
<span class=nb>source</span> ~/.bashrc
etcdctl endpoint health --write-out<span class=o>=</span>table
</code></pre></td></tr></table>
</div>
</div><h1 id=动态添加集群成员>动态添加集群成员</h1>
<p>前边已经配置了两个成员的etcd集群，etcd集群成员少于三个没有冗余性的，下边我们动态添加一个成员</p>
<h2 id=添加集群成员>添加集群成员</h2>
<p>在已经安装etcd集群的节点（node3）通过etcdctl客户端动态添加节点</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>etcdctl member add node2  --peer-urls<span class=o>=</span>https://node2:2380

<span class=c1># 以上命令执行成功会返回新集群的配置参数，如下，记录下来，等会修改集群配置</span>
<span class=nv>ETCD_NAME</span><span class=o>=</span><span class=s2>&#34;node2&#34;</span>
<span class=nv>ETCD_INITIAL_CLUSTER</span><span class=o>=</span><span class=s2>&#34;node1=https://node1:2380,node2=https://node2:2380,node3=https://node3:2380&#34;</span>
<span class=nv>ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class=o>=</span><span class=s2>&#34;https://node2:2380&#34;</span>
<span class=nv>ETCD_INITIAL_CLUSTER_STATE</span><span class=o>=</span><span class=s2>&#34;existing&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=修改配置文件>修改配置文件</h2>
<blockquote>
<p>根据上边命令回显，node2添加配置如下</p>
</blockquote>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>cat &gt; /opt/etcd/etc/etcd.conf<span class=s>&lt;&lt;EOF
</span><span class=s>name: &#39;node2&#39;
</span><span class=s>data-dir: &#39;&#39;
</span><span class=s>wal-dir: &#39;&#39;
</span><span class=s>listen-peer-urls: https://192.168.122.11:2380
</span><span class=s>listen-client-urls: https://192.168.122.11:2379,https://127.0.0.1:2379
</span><span class=s>initial-advertise-peer-urls: https://node2:2380
</span><span class=s>advertise-client-urls: https://node2:2379
</span><span class=s>initial-cluster: node1=https://node1:2380,node2=https://node2:2380,node3=https://node3:2380
</span><span class=s>initial-cluster-token: &#39;k8s&#39;
</span><span class=s>initial-cluster-state: &#39;existing&#39;
</span><span class=s>enable-v2: true
</span><span class=s>enable-pprof: true
</span><span class=s>debug: false
</span><span class=s>logger: zap
</span><span class=s>client-transport-security:
</span><span class=s>    cert-file: /opt/etcd/ssl/etcd-server.crt
</span><span class=s>    key-file: /opt/etcd/ssl/etcd-server.key
</span><span class=s>    client-cert-auth: true
</span><span class=s>    trusted-ca-file: /opt/etcd/ssl/etcd-ca.crt
</span><span class=s>    auto-tls: false
</span><span class=s>peer-transport-security:
</span><span class=s>    cert-file: /opt/etcd/ssl/etcd-server.crt
</span><span class=s>    key-file: /opt/etcd/ssl/etcd-server.key
</span><span class=s>    client-cert-auth: true
</span><span class=s>    trusted-ca-file: /opt/etcd/ssl/etcd-ca.crt
</span><span class=s>    auto-tls: false
</span><span class=s>EOF</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=启动新节点>启动新节点</h2>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=c1># 设置目录用户组</span>
chown etcd:etcd -R /opt/etcd
chmod <span class=m>700</span> /opt/etcd/data
restorecon -R /opt/etcd

<span class=c1># 启动服务</span>
systemctl daemon-reload
systemctl start etcd.service
systemctl <span class=nb>enable</span> etcd.service
</code></pre></td></tr></table>
</div>
</div><h2 id=测试etcd-1>测试etcd</h2>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>etcdctl endpoint health --write-out<span class=o>=</span>table
</code></pre></td></tr></table>
</div>
</div></div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>更新于 2021-12-06&nbsp;<a class=git-hash href=https://github.com/zccing/zccing.github.io/commit/f7e90a527baa175295a870d6f1a4035200a3dc6c target=_blank title="commit by Cc(alex_zjf@163.com) f7e90a527baa175295a870d6f1a4035200a3dc6c: 更换成LoveIt模板">
<i class="fas fa-hashtag fa-fw"></i>f7e90a5</a></span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md></div>
<div class=post-info-share>
<span><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://www.net-cc.com/etcd-install/ data-title=etcd安装配置笔记><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://www.net-cc.com/etcd-install/ data-title=etcd安装配置笔记><i class="fab fa-evernote fa-fw"></i></a></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/k8s/>K8S</a>,&nbsp;<a href=/tags/etcd/>etcd</a></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span>
</section>
</div>
<div class=post-nav><a href=/openssl/ class=prev rel=prev title=openssl证书管理><i class="fas fa-angle-left fa-fw"></i>openssl证书管理</a>
<a href=/k8s-install/ class=next rel=next title=二进制方式安装K8S>二进制方式安装K8S<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.89.4">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://www.net-cc.com target=_blank>cc</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br>
<span class=icp><a rel=备案查询 href=https://beian.miit.gov.cn/ target=_blank>豫ICP备2021035180号</a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部>
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论>
<i class="fas fa-comment fa-fw"></i>
</a>
</div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:5},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body>
</html>